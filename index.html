<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        .dashboard {
            display: grid;
            grid: "a b c" auto / 1fr 1fr 1fr;
            position: fixed;
            right: 0;
            left: 0;
            bottom: 0;
            padding: 16px 12px;
        }
    </style>
    <script src="Vector.js"></script>
</head>
<body>
    <canvas id="canvas" style="display: block"></canvas>
    <div class="dashboard">
        <div>
            <button id="addConvexBtn">添加一个凸包</button>
            <button id="createSegmentBtn">添加一个线段</button>
            <button id="createPoint">添加一个点</button>

            <button id="toLeftTestBtn">进行toLeft测试</button>
        </div>
        <div>
            <p id="info" style="color: white; text-align: center">说明文字</p>
        </div>
        <div>
            <button id="endBtn" style="display: none">结束</button>
        </div>
    </div>

    <script>
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        window.onresize = () =>
        {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        const Mode = {
            None : 1,
            AddConvex : 2,
            AddSegment : 3,
            AddPoint : 4,
            ToLeftTest : 5,
            SelectSegment : 6,
        }

        const ConvexList = []
        const SegmentList = []
        const PointList = []

        let mode = Mode.None;
        let ctx = canvas.getContext("2d");

        UpdateInfo();

        addConvexBtn.addEventListener("click", evt => {
            mode = Mode.AddConvex;
            UpdateInfo();
            evt.preventDefault()
            evt.stopPropagation()

            endBtn.style.display = "inline-block"
            endBtn.addEventListener("click", endBtnClickHandler)
            window.addEventListener("click", clickHandler);
            let c = new Convex([])
            ConvexList.push(c)

            function clickHandler(evt) {
                c.AddPoint(new Vector2(evt.offsetX, evt.offsetY));
            }

            function endBtnClickHandler(evt){
                if (c.verteis.length === 0) {
                    ConvexList.slice(ConvexList.indexOf(c), 1)
                }
                window.removeEventListener("click", clickHandler);
                endBtn.removeEventListener("click", endBtnClickHandler)
                mode = Mode.None;
                UpdateInfo();

                endBtn.style.display = "none"
            }
        })

        createSegmentBtn.addEventListener("click", evt => {
            mode = Mode.AddSegment;
            UpdateInfo();
            evt.preventDefault()
            evt.stopPropagation()
            let startVector = null;
            let endVector = null;

            function clickHandler(evt) {
                if (startVector === null) {
                    startVector = new Vector2(evt.offsetX, evt.offsetY)
                    PointList.push(startVector)
                }
                else if (endVector === null){
                    endVector = new Vector2(evt.offsetX, evt.offsetY);
                    PointList.splice(PointList.indexOf(startVector), 1);
                    SegmentList.push(new Segment(startVector, endVector))
                    window.removeEventListener("click", clickHandler)
                    mode = Mode.None;
                    UpdateInfo();
                }

            }
            window.addEventListener("click", clickHandler)
        })

        createPoint.addEventListener("click", evt => {
            mode = Mode.AddPoint;
            UpdateInfo();
            evt.preventDefault()
            evt.stopPropagation()
            function clickHandler(evt) {
                PointList.push(new Vector2(evt.offsetX, evt.offsetY))
                mode = Mode.None;
                UpdateInfo();
                window.removeEventListener("click", clickHandler)
            }
            window.addEventListener("click", clickHandler)
        })

        toLeftTestBtn.addEventListener("click", evt => {
            mode = Mode.SelectSegment
            UpdateInfo();
            evt.preventDefault()
            evt.stopPropagation()

            let findSegment = null;
            let selectedSegment = null;

            endBtn.style.display = "inline-block"
            endBtn.addEventListener("click", endBtnClickHandler)
            window.addEventListener("mousemove", MouseMoveHandler)
            window.addEventListener("click", ClickHandler)

            function MouseMoveHandler(evt) {
                switch (mode) {
                    case Mode.SelectSegment:
                        findSegment = null;
                        SegmentList.forEach(s => {
                            if (s.PointInPath(ctx, evt.offsetX, evt.offsetY)) {
                                s.lineWidth = 4;
                                findSegment = s;
                            }else {
                                s.lineWidth = 2;
                            }
                        })
                        break
                    case Mode.ToLeftTest:
                        let point = new Vector2(evt.offsetX, evt.offsetY)
                        selectedSegment.color = Vector2.ToLeft(selectedSegment.start, selectedSegment.end, point) ? "green" : "red"
                        break;
                }
            }

            function ClickHandler(evt) {
                selectedSegment = findSegment
                if (selectedSegment !== null) {
                    mode = Mode.ToLeftTest
                    UpdateInfo();
                }
            }

            function endBtnClickHandler(evt){
                window.removeEventListener("mousemove", MouseMoveHandler)
                window.removeEventListener("click", ClickHandler)
                endBtn.removeEventListener("click", endBtnClickHandler)
                mode = Mode.None;
                UpdateInfo();

                endBtn.style.display = "none"
            }
        })

        Tick();

        function UpdateInfo() {
            switch (mode) {
                case Mode.None:
                    info.innerText = "等待指令"
                    break
                case Mode.AddPoint:
                    info.innerText = "添加一个点"
                    break
                case Mode.AddConvex:
                    info.innerText = "添加多个点，以组成凸包"
                    break
                case Mode.AddSegment:
                    info.innerText = "添加两个点，以组成线段"
                    break
                case Mode.ToLeftTest:
                    info.innerText = "检查鼠标位置是否在线段的左侧"
                    break
                case Mode.SelectSegment:
                    info.innerText = "选择一条线段"
                    break
            }
        }

        function Tick() {
            ctx.reset()

            ctx.fillStyle = "#1b1b1b"
            ctx.fillRect(0, 0, canvas.width, canvas.height)


            PointList.forEach(c => c.Draw(ctx))
            SegmentList.forEach(c => c.Draw(ctx))
            ConvexList.forEach(c => c.Draw(ctx))
            requestAnimationFrame(Tick)
        }
    </script>
</body>
</html>